<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="../../tests/bootstrap.min.css">

    <style type="text/css">
        body {
            display: flex;
            justify-content: center;
        }
        canvas {
            image-rendering: optimizeSpeed;
            background-color: black;
        }
        .displays {
            display: flex;
            justify-content: center;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: pointer;
        }
        .displays canvas {
            border: 5px solid black;
            margin: 5px;
        }
        .center {
            width: 900px;
        }
        .flex { display: flex; }
        #fps { display: none; }
        input, button { margin: 5px; }
        #output { width: 100%; margin: 5px;}
    </style>
</head>

<body>
    <div class="center">
        <div class="page-header">
            <h1>MultiCanvas SNES Sample</h1>
        </div>
        <div class="displays well">
            <canvas id="canvas" width="256" height="239"></canvas>
        </div>
        <ul class="nav nav-tabs">
            <li class="active"><a href="#host" data-toggle="tab">Host</a></li>
            <li><a href="#client" data-toggle="tab">Client</a></li>
            <li><a href="#controls" data-toggle="tab">Controls</a></li>
            <li><a href="#chat" data-toggle="tab" id="chatTab">Chat</a></li>
        </ul>
        <div class="tab-content well">
            <div class="tab-pane active" id="host">
                <input type="text" id="fps" size="5"/>
                <div class="form-group">
                <label>Rom</label><input class="btn btn-primary" type="file" onchange="snes_readfile(this)" />
                </div>
                <div class="form-group">
                <label>Host Id (give this to your friend)</label><h4 id="hostId"></h4><br/>
                </div>
                <div class="form-group">
                <label>Quality</label><input id="quality" type="range" min="0" max="100" value="50"/>
                </div>
            </div>
            <div class="tab-pane form" id="client">
                <div class="form-group">
                    <label>Host Id</label>
                    <input id="connectId" type="text" class="form-control" placeholder="ID of host you want to connect to"/>
                </div>
                <button id="startConnect" class="btn btn-success">Connect to Host</button>
            </div>
            <div class="tab-pane" id="controls">
                <table class="table">
                    <tr>
                        <th>SNES</th>
                        <th>Keyboard</th>
                    </tr>
                    <tr>
                        <td>Up</td>
                        <td>Up Arrow</td>
                    </tr>
                    <tr>
                        <td>Down</td>
                        <td>Down Arrow</td>
                    </tr>
                    <tr>
                        <td>Left</td>
                        <td>Left Arrow</td>
                    </tr>
                    <tr>
                        <td>Right</td>
                        <td>Right Arrow</td>
                    </tr>
                    <tr>
                        <td>Start</td>
                        <td>Enter</td>
                    </tr>
                    <tr>
                        <td>Select</td>
                        <td>Space</td>
                    </tr>
                    <tr>
                        <td>A</td>
                        <td>D</td>
                    </tr>
                    <tr>
                        <td>B</td>
                        <td>C</td>
                    </tr>
                    <tr>
                        <td>X</td>
                        <td>S</td>
                    </tr>
                    <tr>
                        <td>Y</td>
                        <td>X</td>
                    </tr>
                    <tr>
                        <td>Left Shoulder</td>
                        <td>A</td>
                    </tr>
                    <tr>
                        <td>Right Shoulder</td>
                        <td>Z</td>
                    </tr>
                </table>
            </div>
            <div class="tab-pane" id="chat"></div>
        </div>        
        <div id="status"></div>
        <textarea id="output" class="well">

        </textarea>
    </div>
    
    <script src="http://code.jquery.com/jquery-2.1.0.min.js" type="text/javascript"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../xnes9x.js"></script>
    <script type="text/javascript" src="../../src/peer.js"></script>
    <script type="text/javascript" src="../../src/multicanvas.js"></script>
    <script type="text/javascript">
        var canvasElement = document.getElementById("canvas"),
            mc = MultiCanvas(canvasElement);

        mc.peer.on("open", function(id) {
            document.getElementById("hostId").innerHTML = id;
        });
        
        document.getElementById("startConnect").addEventListener("click", function() {
            mc.connect(document.getElementById("connectId").value)
              .events(document, ["keypress", "keydown", "keyup"]);
        });
        
        document.getElementById("quality").addEventListener("change", function(e) {
           mc.quality = e.target.value / 100; 
        });
        

         // not responsible for the following :/
        // shim layer with setTimeout fallback
        window.requestAnimFrame = (function(){
          return  window.requestAnimationFrame       ||
                  window.webkitRequestAnimationFrame ||
                  window.mozRequestAnimationFrame    ||
                  function( callback ){
                    window.setTimeout(callback, 1000 / 60);
                  };
        })();

         frameskip = 0
         maincanvas = document.getElementById("canvas")
         mainctx = maincanvas.getContext("2d");
         imgData = mainctx.createImageData(288, 224)
         cout = document.getElementById("output")

        function cout_print(txt) {
            cout.value += txt + "\n"
            cout.scrollTop = 999999
        }
        snes_transparency = 1

        function snes_mainloop() {
            mainloop(frameskip)
            frameskipped += frameskip
            frames++
            if (frames + frameskipped >= 60) {
                this_time = new Date().getTime()
                fps_text.value = ((frames + frameskipped) * 1000 / (this_time - last_time)).toFixed(3)
                last_time = this_time
                frameskipped = frames = 0
            }
            requestAnimFrame(snes_mainloop);

        }

        function snes_init() {
            reboot_emulator = Module.cwrap('reboot_emulator', 'number', ['string'])
            native_set_joypad_state = Module._native_set_joypad_state
            native_bitmap_pointer = Module._native_bitmap_pointer
            mainloop = Module._mainloop
            renderscreen = Module._renderscreen
            fps_text = document.getElementById("fps")
            reboot_emulator("/_.smc")
            frameskipped = 0
            for (var i = 0; i < 288 * 224 * 4; i += 4) {
                imgData.data[i + 3] = 0xff
            }

        }

        function frameskip_adjust(n) {
            frameskip += n
            if (frameskip < 0) frameskip = 0
            frameskip_text.value = frameskip
        }

        function snes_readfile(controller) {
            if (window.File && window.FileReader && window.FileList && window.Blob) {} else {
                alert('The File APIs are not fully supported in this browser.');
            }
            var f = controller.files[0]
            cout_print(f.name)
            var reader = new FileReader()
            reader.onprogress = function(e) {
                if (e.lengthComputable) {
                    cout_print(Math.round((e.loaded / e.total) * 100) + "%")
                } else
                    count_print(e.loaded + "bytes")


            }
            reader.onload = function(e) {
                cout_print("_.smc loaded")
                Module.FS_createDataFile("/", "_.smc", new Uint8Array(this.result), true, true)
                snes_main();
                mc.host(1000 / 24).events(document);
            }
            reader.readAsArrayBuffer(f)
        }

        function snes_main() {
            snes_init()
            reboot_romnum = -1
            frames = 0
            last_time = new Date().getTime()
            snes_mainloop();
        }

        function snes_test(render) {
            snes_init()
            start_time = new Date().getTime()
            for (var i = 0; i < 5000; i++) {
                mainloop(palf ? 312 : 262)
                if (render)
                    renderscreen()
            }
            end_time = new Date().getTime()
            fps_text.value = ((end_time - start_time) / 1000).toFixed(3)
        }
    </script>
</body>

</html>